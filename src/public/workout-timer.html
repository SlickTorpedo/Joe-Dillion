<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight Training Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .motivational-section {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .urgent-reminder {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .progress-reminder {
            background: linear-gradient(135deg, #374151, #4b5563);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 12px 24px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.8);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-tab.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workout-setup {
            text-align: center;
        }

        .duration-input-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .duration-input-section h3 {
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 400;
        }

        .duration-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .duration-input {
            width: 100px;
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.3em;
            text-align: center;
            font-weight: bold;
        }

        .duration-input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .exercise-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 8px;
            border-left: 4px solid #dc2626;
        }

        .quick-duration-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: rgba(30, 30, 30, 0.7);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .quick-btn:hover {
            background: rgba(220, 38, 38, 0.2);
            border-color: #dc2626;
            color: #dc2626;
        }

        .weight-input {
            margin: 20px 0;
        }

        .weight-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #ffffff;
        }

        .weight-input input {
            width: 120px;
            padding: 10px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.1em;
            text-align: center;
        }

        .weight-input input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .start-btn {
            padding: 18px 45px;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .timer-display {
            text-align: center;
        }

        .current-exercise {
            font-size: 2.8em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 5em;
            font-weight: bold;
            color: #dc2626;
            margin: 30px 0;
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .timer.warning {
            color: #f59e0b;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transition: width 1s ease;
        }

        .workout-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: rgba(30, 30, 30, 0.9);
            border-color: #dc2626;
        }

        .info-label {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffffff;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pause-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #dc2626;
        }

        .stat-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: bold;
            color: #dc2626;
        }

        .history-item {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(30, 30, 30, 0.9);
            border-color: #dc2626;
            transform: translateX(5px);
        }

        .motivational-quote {
            background: linear-gradient(135dc, #dc2626, #b91c1c);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .achievements {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .achievement {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .achievement:hover {
            transform: translateY(-2px);
        }

        .gym-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .gym-open {
            background: linear-gradient(45deg, #374151, #4b5563);
            color: white;
        }

        .gym-closing-soon {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            animation: pulse 2s infinite;
        }

        .gym-closed {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }

        .next-exercise-warning {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid #dc2626;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .loading {
            text-align: center;
            color: #a0a0a0;
            padding: 20px;
        }

        .error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid #dc2626;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #dc2626;
            text-align: center;
        }

        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .username-modal-content {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .username-modal-content h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .username-modal-content p {
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .username-input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .username-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.1em;
        }

        .username-input-group input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .username-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .username-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .username-note {
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
        }

        .user-info {
            background: rgba(30, 30, 30, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info .username {
            color: #dc2626;
            font-weight: 600;
        }

        .change-user-btn {
            padding: 5px 15px;
            background: transparent;
            color: #a0a0a0;
            border: 1px solid #404040;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .change-user-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
        }
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .timer {
                font-size: 3.5em;
            }
            
            .current-exercise {
                font-size: 2em;
            }

            .duration-controls {
                flex-direction: column;
                gap: 10px;
            }

            .quick-duration-btns {
                gap: 5px;
            }

            .quick-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
    </style>
</head>
<body>
        <!-- Username Modal -->
        <div id="username-modal" class="username-modal" style="display: none;">
            <div class="username-modal-content">
                <h2>Welcome to Weight Training Timer</h2>
                <p>Enter your username to save your progress permanently</p>
                <div class="username-input-group">
                    <input type="text" id="username-input" placeholder="Enter your username" maxlength="20">
                    <button onclick="setUsername()" class="username-btn">Continue</button>
                </div>
                <p class="username-note">Your username will be saved and your progress will be preserved across devices</p>
            </div>
        </div>

        <div class="container">
        <div class="card">
            <div class="header">
                <h1>WEIGHT TRAINING TIMER</h1>
                <div id="user-info" class="user-info" style="display: none;">
                    <span>Welcome back, <span class="username" id="current-username"></span>!</span>
                    <button class="change-user-btn" onclick="changeUser()">Change User</button>
                </div>
            </div>

            <div id="progress-motivator"></div>
            <div id="gym-status"></div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('workout')">Workout</button>
                <button class="nav-tab" onclick="showTab('stats')">Stats</button>
                <button class="nav-tab" onclick="showTab('history')">History</button>
                <a href="/dashboard" class="nav-tab">Dashboard</a>
            </div>

            <div id="workout-tab" class="tab-content active">
                <div id="setup-screen" class="workout-setup">
                    <div class="motivational-section">
                        <div class="motivational-quote" id="motivational-quote">
                            "Consistency builds champions"
                        </div>
                        <div id="daily-motivation"></div>
                    </div>

                    <div class="duration-input-section">
                        <h3>Workout Duration</h3>
                        
                        <div class="quick-duration-btns">
                            <button class="quick-btn" onclick="setDuration(10)">10 min</button>
                            <button class="quick-btn" onclick="setDuration(20)">20 min</button>
                            <button class="quick-btn" onclick="setDuration(30)">30 min</button>
                            <button class="quick-btn" onclick="setDuration(45)">45 min</button>
                            <button class="quick-btn" onclick="setDuration(60)">1 hour</button>
                            <button class="quick-btn" onclick="setDuration(90)">1.5 hours</button>
                        </div>

                        <div class="duration-controls">
                            <label for="duration-input" style="color: #ffffff; font-weight: 600;">Custom Duration (minutes):</label>
                            <input type="number" id="duration-input" class="duration-input" value="30" min="5" max="180" onchange="updateExerciseBreakdown()">
                        </div>

                        <div class="exercise-breakdown" id="exercise-breakdown">
                            <strong>Workout Breakdown:</strong><br>
                            <span id="breakdown-text">15 exercises total • 1 warmup + 14 working sets</span>
                        </div>
                    </div>

                    <div class="weight-input">
                        <label for="starting-weight">Starting Weight (lbs):</label>
                        <input type="number" id="starting-weight" value="1" min="1" max="10" step="1">
                        <p style="color: #a0a0a0; font-size: 0.9em; margin-top: 5px;">Max weight: 10 lbs</p>
                    </div>

                    <button class="start-btn" onclick="startWorkout()">Start Workout</button>
                </div>

                <div id="timer-screen" class="timer-display" style="display: none;">
                    <div id="next-exercise-warning" style="display: none;"></div>
                    <div class="current-exercise" id="current-exercise">Warmup</div>
                    <div class="timer" id="timer-display">2:00</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>

                    <div class="workout-info">
                        <div class="info-card">
                            <div class="info-label">Current Weight</div>
                            <div class="info-value" id="current-weight">1 lbs</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Total Time</div>
                            <div class="info-value" id="total-time">0:00</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Exercise</div>
                            <div class="info-value" id="exercise-count">1 / 15</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Remaining</div>
                            <div class="info-value" id="remaining-time">30:00</div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="control-btn pause-btn" onclick="togglePause()" id="pause-btn">Pause</button>
                        <button class="control-btn stop-btn" onclick="stopWorkout()">Stop</button>
                    </div>
                </div>
            </div>

            <div id="stats-tab" class="tab-content">
                <div id="stats-loading" class="loading">Loading stats...</div>
                <div id="stats-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-title">Total Workouts</div>
                            <div class="stat-value" id="total-workouts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Total Time</div>
                            <div class="stat-value" id="total-time-stats">0h 0m</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">This Week</div>
                            <div class="stat-value" id="this-week-workouts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Max Weight</div>
                            <div class="stat-value" id="max-weight">0 lbs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Streak</div>
                            <div class="stat-value" id="current-streak">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Week Goal</div>
                            <div class="stat-value" id="weekly-progress">0/7</div>
                        </div>
                    </div>

                    <div class="achievements" id="achievements">
                        <!-- Achievements will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="history-tab" class="tab-content">
                <h2 style="text-align: center; margin-bottom: 20px; color: #ffffff;">Workout History</h2>
                <div id="history-loading" class="loading">Loading history...</div>
                <div id="history-list" style="display: none;">
                    <!-- History will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Workout data and state
        let workoutData = {
            duration: 30, // minutes
            startingWeight: 1,
            exercises: ['Warmup', 'Flys', 'Side Raises', 'Overhead', 'Flys', 'Side Raises'],
            exerciseTime: 2 * 60, // 2 minutes in seconds
            currentExercise: 0,
            currentWeight: 1,
            timeRemaining: 2 * 60,
            totalElapsed: 0,
            totalWorkoutTime: 0,
            isRunning: false,
            isPaused: false,
            intervalId: null,
            lastBeepTime: 0,
            workoutId: null
        };

        const workoutColors = {
            Warmup: '#10b981', // Green
            Flys: '#dc2626', // Red
            'Side Raises': '#2563eb', // Blue
            Overhead: '#f59e0b', // Yellow
        };

        // Motivational quotes
        const motivationalQuotes = [
            "Consistency builds champions",
            "Every rep counts",
            "Progress over perfection",
            "Show up and do the work",
            "Your future self will thank you",
            "Strength comes from within",
            "Push through the resistance",
            "Make it happen",
            "Focus on the process",
            "Results follow effort"
        ];

        // Audio context for beeps
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBeep(frequency = 800, duration = 200) {
            if (!audioContext) initAudio();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // User management
        function getUserId() {
            const username = localStorage.getItem('workoutUsername');
            if (!username) {
                return null; // Will trigger username modal
            }
            return `user_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
        }

        function getUsername() {
            return localStorage.getItem('workoutUsername');
        }

        async function setUsername() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            if (username.length < 2) {
                alert('Username must be at least 2 characters long');
                return;
            }
            
            // Validate username (alphanumeric and basic chars only)
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                alert('Username can only contain letters, numbers, hyphens, and underscores');
                return;
            }
            
            try {
                // Check if username exists by trying to get stats
                const userId = `user_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
                const existingStats = await apiCall(`/workouts/stats/${userId}`);
                
                // Store username
                localStorage.setItem('workoutUsername', username);
                
                // Hide modal and show user info
                document.getElementById('username-modal').style.display = 'none';
                document.getElementById('current-username').textContent = username;
                document.getElementById('user-info').style.display = 'flex';
                
                // If user has existing data, welcome them back
                if (existingStats && existingStats.success && existingStats.totalWorkouts > 0) {
                    setTimeout(() => {
                        alert(`Welcome back, ${username}! You have ${existingStats.totalWorkouts} workouts completed.`);
                    }, 500);
                }
                
                // Initialize the app
                init();
                
            } catch (error) {
                console.error('Error setting username:', error);
                alert('There was an error setting your username. Please try again.');
            }
        }

        function changeUser() {
            if (confirm('Are you sure you want to change users? This will switch to a different account.')) {
                localStorage.removeItem('workoutUsername');
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('username-input').value = '';
                document.getElementById('username-modal').style.display = 'flex';
            }
        }

        // Check for Enter key in username input
        function setupUsernameInput() {
            const usernameInput = document.getElementById('username-input');
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setUsername();
                }
            });
            
            // Focus the input when modal opens
            setTimeout(() => {
                usernameInput.focus();
            }, 100);
        }

        // API helper functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return null;
            }
        }

        // Check gym hours and status
        async function updateGymStatus() {
            try {
                const response = await fetch('/gym-status');
                const gymStatus = await response.json();
                
                if (gymStatus.success) {
                    const statusElement = document.getElementById('gym-status');
                    statusElement.className = `gym-status gym-${gymStatus.status}`;
                    statusElement.innerHTML = gymStatus.message;
                }
            } catch (error) {
                console.error('Failed to get gym status:', error);
            }
        }

        // Get motivational progress message
        async function updateProgressMotivator() {
            const userId = getUserId();
            
            try {
                const stats = await apiCall(`/workouts/stats/${userId}`);
                
                if (stats && stats.success) {
                    const thisWeekWorkouts = stats.thisWeekWorkouts || 0;
                    const workoutsLeft = 7 - thisWeekWorkouts;
                    
                    // Check if user worked out today
                    const history = await apiCall(`/workouts/history/${userId}?limit=1`);
                    const today = new Date().toDateString();
                    const todayWorkout = history?.workouts?.find(w => 
                        new Date(w.endTime || w.startTime).toDateString() === today
                    );
                    
                    let message = '';
                    let isUrgent = false;
                    
                    if (!todayWorkout) {
                        if (workoutsLeft <= 2) {
                            message = `${workoutsLeft} workouts left this week. Today matters.`;
                            isUrgent = true;
                        } else {
                            message = `Day ${thisWeekWorkouts + 1} of 7. You need ${workoutsLeft} more this week.`;
                        }
                    } else {
                        message = `Today's workout complete. ${thisWeekWorkouts}/7 this week.`;
                    }
                    
                    const element = document.getElementById('progress-motivator');
                    if (isUrgent) {
                        element.className = 'urgent-reminder';
                    } else {
                        element.className = 'progress-reminder';
                    }
                    element.innerHTML = message;
                }
            } catch (error) {
                console.error('Failed to update progress motivator:', error);
            }
        }

        // Set duration from quick buttons
        function setDuration(minutes) {
            document.getElementById('duration-input').value = minutes;
            workoutData.duration = minutes;
            updateExerciseBreakdown();
        }

        // Update exercise breakdown
        function updateExerciseBreakdown() {
            const duration = parseInt(document.getElementById('duration-input').value);
            workoutData.duration = duration;
            workoutData.totalWorkoutTime = duration * 60;
            
            const totalExercises = Math.floor(duration / 2);
            const workingSets = totalExercises - 1; // Minus warmup
            
            const breakdown = document.getElementById('breakdown-text');
            breakdown.innerHTML = `
                ${totalExercises} exercises total • 1 warmup + ${workingSets} working sets
            `;
        }

        // Show random motivational quote
        function showRandomQuote() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            document.getElementById('motivational-quote').textContent = quote;
        }

        // Update daily motivation
        async function updateDailyMotivation() {
            const userId = getUserId();
            
            try {
                const history = await apiCall(`/workouts/history/${userId}?limit=5`);
                const today = new Date().toDateString();
                const todayWorkout = history?.workouts?.find(w => 
                    new Date(w.endTime || w.startTime).toDateString() === today
                );
                
                const motivationElement = document.getElementById('daily-motivation');
                
                if (!todayWorkout) {
                    motivationElement.innerHTML = `
                        <div style="font-size: 1.1em; font-weight: 600;">
                            Ready to get your daily workout done?
                        </div>
                    `;
                } else {
                    motivationElement.innerHTML = `
                        <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">
                            ✓ Daily goal completed! Well done.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to update daily motivation:', error);
            }
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Update stats when showing stats tab
            if (tabName === 'stats') {
                updateStats();
            } else if (tabName === 'history') {
                updateHistory();
            }
        }

        // Start workout
        async function startWorkout() {
            initAudio(); // Initialize audio context
            
            const userId = getUserId();
            const duration = workoutData.duration;
            const startingWeight = parseInt(document.getElementById('starting-weight').value);
            
            try {
                // Start workout on backend
                const result = await apiCall('/workouts/start', 'POST', {
                    userId,
                    duration,
                    startingWeight
                });
                
                if (result && result.success && result.workoutId) {
                    workoutData.workoutId = result.workoutId;
                }
            } catch (error) {
                console.error('Failed to start workout on backend:', error);
            }
            
            workoutData.startingWeight = startingWeight;
            workoutData.currentWeight = startingWeight;
            workoutData.currentExercise = 0;
            workoutData.timeRemaining = workoutData.exerciseTime;
            workoutData.totalElapsed = 0;
            workoutData.isRunning = true;
            workoutData.isPaused = false;
            workoutData.lastBeepTime = 0;

            // Show timer screen
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('timer-screen').style.display = 'block';

            // Update display
            updateTimerDisplay();
            
            // Start timer
            workoutData.intervalId = setInterval(updateTimer, 1000);
        }

        // Update timer
        function updateTimer() {
            if (workoutData.isPaused) return;

            workoutData.timeRemaining--;
            workoutData.totalElapsed++;

            // Handle beeping for last 5 seconds
            if (workoutData.timeRemaining <= 5 && workoutData.timeRemaining > 0) {
                if (workoutData.timeRemaining !== workoutData.lastBeepTime) {
                    playBeep(1000, 150);
                    workoutData.lastBeepTime = workoutData.timeRemaining;
                }
            }

            updateTimerDisplay();

            // Check if exercise is complete
            if (workoutData.timeRemaining <= 0) {
                nextExercise();
            }

            // Check if workout is complete
            const totalExercises = Math.floor(workoutData.duration / 2);
            if (workoutData.currentExercise >= totalExercises) {
                completeWorkout();
            }
        }

        // Move to next exercise
        function nextExercise() {
            // Play completion sound
            playBeep(1200, 300);
            
            workoutData.currentExercise++;
            workoutData.timeRemaining = workoutData.exerciseTime;
            workoutData.lastBeepTime = 0;

            // Update weight progression
            if (workoutData.currentExercise > 1) { // After warmup
                const progressionStep = Math.floor((workoutData.currentExercise - 1) / 2);
                const weightProgression = [1, 10, 15, 20, 25, 30, 35, 40, 45, 50];
                workoutData.currentWeight = weightProgression[Math.min(progressionStep, weightProgression.length - 1)];
            }

            updateTimerDisplay();
            showNextExerciseAnnouncement();
        }

        // Show next exercise announcement
        function showNextExerciseAnnouncement() {
            const totalExercises = Math.floor(workoutData.duration / 2);
            if (workoutData.currentExercise < totalExercises) {
                const nextExerciseIndex = workoutData.currentExercise % workoutData.exercises.length;
                const nextExerciseName = workoutData.exercises[nextExerciseIndex];
                
                const warningElement = document.getElementById('next-exercise-warning');
                warningElement.className = 'next-exercise-warning';
                warningElement.innerHTML = `Now starting: ${nextExerciseName}`;
                warningElement.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    warningElement.style.display = 'none';
                }, 3000);
            }
        }

        // Update timer display with workout color
        function updateTimerDisplay() {
            const minutes = Math.floor(workoutData.timeRemaining / 60);
            const seconds = workoutData.timeRemaining % 60;
            const timerElement = document.getElementById('timer-display');
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Add warning class for last 10 seconds
            if (workoutData.timeRemaining <= 10 && workoutData.timeRemaining > 0) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }

            // Update exercise name and color
            const exerciseIndex = workoutData.currentExercise % workoutData.exercises.length;
            const currentExerciseName = workoutData.exercises[exerciseIndex];
            const exerciseColor = workoutColors[currentExerciseName] || '#ffffff'; // Default to white

            const currentExerciseElement = document.getElementById('current-exercise');
            currentExerciseElement.textContent = currentExerciseName;
            currentExerciseElement.style.color = exerciseColor;

            timerElement.style.color = exerciseColor;

            // Update progress bar
            const progress = (workoutData.exerciseTime - workoutData.timeRemaining) / workoutData.exerciseTime * 100;
            document.getElementById('progress-fill').style.width = progress + '%';

            // Update info cards
            document.getElementById('current-weight').textContent = workoutData.currentWeight + ' lbs';

            const totalMinutes = Math.floor(workoutData.totalElapsed / 60);
            const totalSeconds = workoutData.totalElapsed % 60;
            document.getElementById('total-time').textContent =
                `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;

            const totalExercises = Math.floor(workoutData.duration / 2);
            document.getElementById('exercise-count').textContent =
                `${workoutData.currentExercise + 1} / ${totalExercises}`;

            // Update remaining workout time
            const remainingWorkoutTime = workoutData.totalWorkoutTime - workoutData.totalElapsed;
            const remainingMinutes = Math.floor(remainingWorkoutTime / 60);
            const remainingSeconds = remainingWorkoutTime % 60;
            document.getElementById('remaining-time').textContent =
                `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Toggle pause
        function togglePause() {
            workoutData.isPaused = !workoutData.isPaused;
            document.getElementById('pause-btn').textContent = workoutData.isPaused ? 'Resume' : 'Pause';
        }

        // Stop workout
        function stopWorkout() {
            if (confirm('Are you sure you want to stop the workout?')) {
                clearInterval(workoutData.intervalId);
                workoutData.isRunning = false;
                
                // Return to setup screen
                document.getElementById('timer-screen').style.display = 'none';
                document.getElementById('setup-screen').style.display = 'block';
                
                showRandomQuote();
                updateDailyMotivation();
            }
        }

        // Complete workout
        async function completeWorkout() {
            clearInterval(workoutData.intervalId);
            workoutData.isRunning = false;

            // Play completion sound
            playBeep(1500, 500);

            const userId = getUserId();
            let backendSuccess = false;

            try {
                // Complete the workout on backend
                if (workoutData.workoutId) {
                    const result = await apiCall(`/workouts/complete/${workoutData.workoutId}`, 'POST', {
                        actualTime: Math.floor(workoutData.totalElapsed / 60),
                        maxWeight: workoutData.currentWeight,
                        completed: true
                    });
                    
                    if (result && result.success) {
                        // Check for new achievements
                        const achievementResult = await apiCall(`/workouts/achievements/check/${userId}`, 'POST');
                        
                        if (achievementResult && achievementResult.newAchievements && achievementResult.newAchievements.length > 0) {
                            // Show achievement notifications
                            setTimeout(() => {
                                achievementResult.newAchievements.forEach(achievement => {
                                    alert(`🏆 Achievement Unlocked: ${achievement.name}!`);
                                });
                            }, 1000);
                        }
                        
                        backendSuccess = true;
                    }
                }
            } catch (error) {
                console.error('Failed to save workout to backend:', error);
            }

            // Fallback to local storage if backend fails
            if (!backendSuccess) {
                const data = JSON.parse(localStorage.getItem('workoutAppData') || '{}');
                if (!data.workouts) data.workouts = [];
                if (!data.achievements) data.achievements = [];
                
                const workout = {
                    date: new Date().toISOString(),
                    duration: workoutData.duration,
                    actualTime: Math.floor(workoutData.totalElapsed / 60),
                    startingWeight: workoutData.startingWeight,
                    maxWeight: workoutData.currentWeight,
                    completed: true
                };

                data.workouts.unshift(workout);
                data.totalWorkouts = (data.totalWorkouts || 0) + 1;
                data.totalTimeMinutes = (data.totalTimeMinutes || 0) + workout.actualTime;
                data.maxWeight = Math.max(data.maxWeight || 0, workout.maxWeight);

                localStorage.setItem('workoutAppData', JSON.stringify(data));
            }

            // Show completion message
            alert('🎉 Workout Complete! Great job!');

            // Return to setup screen
            document.getElementById('timer-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
            
            showRandomQuote();
            updateDailyMotivation();
            updateProgressMotivator();
        }

        // Update stats display
        async function updateStats() {
            const userId = getUserId();
            const statsContent = document.getElementById('stats-content');
            const statsLoading = document.getElementById('stats-loading');
            
            try {
                statsLoading.style.display = 'block';
                statsContent.style.display = 'none';
                
                const [stats, achievements] = await Promise.all([
                    apiCall(`/workouts/stats/${userId}`),
                    apiCall(`/workouts/achievements/${userId}`)
                ]);
                
                if (stats && stats.success) {
                    document.getElementById('total-workouts').textContent = stats.totalWorkouts || 0;
                    
                    const hours = Math.floor((stats.totalTimeMinutes || 0) / 60);
                    const minutes = (stats.totalTimeMinutes || 0) % 60;
                    document.getElementById('total-time-stats').textContent = `${hours}h ${minutes}m`;
                    
                    document.getElementById('this-week-workouts').textContent = stats.thisWeekWorkouts || 0;
                    document.getElementById('max-weight').textContent = (stats.maxWeight || 0) + ' lbs';
                    document.getElementById('current-streak').textContent = stats.currentStreak || 0;
                    document.getElementById('weekly-progress').textContent = stats.weeklyProgress || '0/7';
                }
                
                // Update achievements display
                const achievementsContainer = document.getElementById('achievements');
                const achievementLabels = {
                    'first-workout': 'First Workout',
                    'ten-workouts': '10 Workouts',
                    'fifty-workouts': '50 Workouts',
                    'hundred-workouts': '100 Workouts',
                    'heavy-lifter': 'Heavy Lifter (25+ lbs)',
                    'serious-lifter': 'Serious Lifter (50+ lbs)',
                    'marathon': 'Marathon (5+ hours)',
                    'dedication': 'Dedication (16+ hours)',
                    'week-streak': '7-Day Streak',
                    'month-streak': '30-Day Streak'
                };

                achievementsContainer.innerHTML = '';
                if (achievements && achievements.success && achievements.achievements.length > 0) {
                    achievements.achievements.forEach(achievementId => {
                        const div = document.createElement('div');
                        div.className = 'achievement';
                        div.textContent = achievementLabels[achievementId] || achievementId;
                        achievementsContainer.appendChild(div);
                    });
                } else {
                    achievementsContainer.innerHTML = '<div style="text-align: center; color: #a0a0a0;">Complete workouts to unlock achievements</div>';
                }
                
                statsLoading.style.display = 'none';
                statsContent.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load stats:', error);
                statsLoading.innerHTML = '<div class="error">Failed to load stats. Please try again.</div>';
            }
        }

        // Update history display
        async function updateHistory() {
            const userId = getUserId();
            const historyList = document.getElementById('history-list');
            const historyLoading = document.getElementById('history-loading');
            
            try {
                historyLoading.style.display = 'block';
                historyList.style.display = 'none';
                
                const history = await apiCall(`/workouts/history/${userId}?limit=20`);
                
                if (history && history.success && history.workouts.length > 0) {
                    historyList.innerHTML = '';
                    
                    history.workouts.forEach(workout => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        
                        const date = new Date(workout.endTime || workout.startTime).toLocaleDateString();
                        const time = new Date(workout.endTime || workout.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        div.innerHTML = `
                            <div>
                                <strong>${date}</strong> at ${time}<br>
                                <small>${workout.duration}min workout • ${workout.startingWeight}-${workout.maxWeight} lbs</small>
                            </div>
                            <div style="text-align: right;">
                                <strong>${workout.actualTime || 0}min</strong><br>
                                <small style="color: #10b981;">✓ Complete</small>
                            </div>
                        `;
                        
                        historyList.appendChild(div);
                    });
                } else {
                    historyList.innerHTML = '<div style="text-align: center; color: #a0a0a0; padding: 40px;">No workouts yet. Start your first workout to track your progress.</div>';
                }
                
                historyLoading.style.display = 'none';
                historyList.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load history:', error);
                historyLoading.innerHTML = '<div class="error">Failed to load workout history. Please try again.</div>';
            }
        }

        // Initialize app
        async function init() {
            // Check if user has set a username
            const username = getUsername();
            if (!username) {
                document.getElementById('username-modal').style.display = 'flex';
                setupUsernameInput();
                return;
            }
            
            // Show user info
            document.getElementById('current-username').textContent = username;
            document.getElementById('user-info').style.display = 'flex';
            
            showRandomQuote();
            updateExerciseBreakdown();
            
            // Load initial data
            await Promise.all([
                updateDailyMotivation(),
                updateProgressMotivator(),
                updateGymStatus()
            ]);
            
            // Update gym status every minute
            setInterval(updateGymStatus, 60000);
            
            // Update progress motivator every 5 minutes
            setInterval(updateProgressMotivator, 5 * 60 * 1000);
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>