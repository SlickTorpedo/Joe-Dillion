<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepForge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
            min-height: 100vh;
            color: #ffffff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .progressive-recommendation {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
        }

        .progressive-recommendation h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            color: white;
        }

        .recommended-weight {
            font-size: 3.5em;
            font-weight: bold;
            color: #ffffff;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .week-info {
            font-size: 1.2em;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .reps-info {
            font-size: 1em;
            color: #ffffff;
            opacity: 0.9;
        }

        .motivational-section {
            background: linear-gradient(135deg, #374151, #4b5563);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .urgent-reminder {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .progress-reminder {
            background: linear-gradient(135deg, #374151, #4b5563);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-tab {
            padding: 12px 24px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(30, 30, 30, 0.8);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
        }

        .nav-tab.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .tab-content {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
            min-height: 400px; /* Provide minimum height to reduce layout shifts */
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Add a consistent container height to minimize jumping */
        #workout-tab, #stats-tab, #history-tab {
            position: relative;
            min-height: 600px; /* Adjust based on your content */
        }

        #stats-tab {
            display: none;
        }

        #history-tab {
            display: none;
        }

        .workout-setup {
            text-align: center;
        }

        .duration-input-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .duration-input-section h3 {
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 400;
        }

        .duration-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .duration-input {
            width: 100px;
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.3em;
            text-align: center;
            font-weight: bold;
        }

        .duration-input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .exercise-breakdown {
            margin-top: 15px;
            padding: 15px;
            background: rgba(10, 10, 10, 0.6);
            border-radius: 8px;
            border-left: 4px solid #dc2626;
        }

        .quick-duration-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            border: 1px solid #404040;
            border-radius: 6px;
            background: rgba(30, 30, 30, 0.7);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .quick-btn:hover {
            background: rgba(220, 38, 38, 0.2);
            border-color: #dc2626;
            color: #dc2626;
        }

        .weight-input {
            margin: 20px 0;
        }

        .weight-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #ffffff;
        }

        .weight-input input {
            width: 120px;
            padding: 10px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.1em;
            text-align: center;
        }

        .weight-input input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .start-btn {
            padding: 18px 45px;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .timer-display {
            text-align: center;
        }

        .current-exercise {
            font-size: 2.8em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 20px;
        }

        .timer {
            font-size: 5em;
            font-weight: bold;
            color: #dc2626;
            margin: 30px 0;
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .timer.warning {
            color: #f59e0b;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transition: width 1s ease;
        }

        .workout-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .info-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            background: rgba(30, 30, 30, 0.9);
            border-color: #dc2626;
        }

        .info-label {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffffff;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pause-btn {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }

        .stop-btn {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
        }

        .skip-btn {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .skip-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        /* Skip Confirmation Modal */
        .skip-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .skip-modal-content {
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        .skip-modal-content h2 {
            color: #f59e0b;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .skip-modal-quote {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-style: italic;
            font-size: 1.1em;
            margin: 20px 0;
            font-weight: 500;
        }

        .skip-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .skip-confirm-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-cancel-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .skip-cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #dc2626;
        }

        .stat-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: bold;
            color: #dc2626;
        }

        .history-item {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(30, 30, 30, 0.9);
            border-color: #dc2626;
            transform: translateX(5px);
        }

        .motivational-quote {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .achievements {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .achievement {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .achievement:hover {
            transform: translateY(-2px);
        }

        .gym-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .gym-open {
            background: linear-gradient(45deg, #374151, #4b5563);
            color: white;
        }

        .gym-closing-soon {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            animation: pulse 2s infinite;
        }

        .gym-closed {
            background: linear-gradient(45deg, #6b7280, #4b5563);
            color: white;
        }

        .next-exercise-warning {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid #dc2626;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .loading {
            text-align: center;
            color: #a0a0a0;
            padding: 20px;
        }

        .error {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid #dc2626;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #dc2626;
            text-align: center;
        }

        .username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .username-modal-content {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .username-modal-content h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .username-modal-content p {
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .username-input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .username-input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #404040;
            border-radius: 8px;
            background: rgba(20, 20, 20, 0.8);
            color: #ffffff;
            font-size: 1.1em;
        }

        .username-input-group input:focus {
            outline: none;
            border-color: #dc2626;
        }

        .username-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .username-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .username-note {
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
        }

        .user-info {
            background: rgba(30, 30, 30, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info .username {
            color: #dc2626;
            font-weight: 600;
        }

        .change-user-btn {
            padding: 5px 15px;
            background: transparent;
            color: #a0a0a0;
            border: 1px solid #404040;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .change-user-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
        }

                @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .timer {
                font-size: 3.5em;
            }
            
            .current-exercise {
                font-size: 2em;
            }
        
            .duration-controls {
                flex-direction: column;
                gap: 10px;
            }
        
            .quick-duration-btns {
                gap: 5px;
            }
        
            .quick-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        
            /* Fix navigation tabs for mobile */
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
            }
        
            .nav-tab {
                width: 100%;
                text-align: center;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
        <!-- Skip Confirmation Modal -->
        <div id="skip-modal" class="skip-modal" style="display: none;">
            <div class="skip-modal-content">
                <h2>⚠️ Skip Exercise?</h2>
                <div class="skip-modal-quote" id="skip-quote">
                    "Champions are made when nobody's watching. Every rep matters."
                </div>
                <p style="color: #a0a0a0; margin: 15px 0;">
                    Are you sure you want to skip this exercise? Remember, consistency builds strength.
                </p>
                <div class="skip-modal-buttons">
                    <button class="skip-cancel-btn" onclick="cancelSkip()">Keep Going 💪</button>
                    <button class="skip-confirm-btn" onclick="confirmSkip()">Skip Exercise</button>
                </div>
            </div>
        </div>

        <!-- Username Modal -->
        <div id="username-modal" class="username-modal" style="display: none;">
            <div class="username-modal-content">
                <h2>Welcome to RepForge</h2>
                <p>Enter your username to save your progress permanently</p>
                <div class="username-input-group">
                    <input type="text" id="username-input" placeholder="Enter your username" maxlength="20">
                    <button onclick="setUsername()" class="username-btn">Continue</button>
                </div>
                <p class="username-note">Your username will be saved and your progress will be preserved across devices</p>
            </div>
        </div>

        <div class="container">
        <div class="card">
            <div class="header">
                <h1>RepForge</h1>
                <div id="user-info" class="user-info" style="display: none;">
                    <span>Welcome back, <span class="username" id="current-username"></span>!</span>
                    <button class="change-user-btn" onclick="changeUser()">Change User</button>
                </div>
            </div>

            <!-- Progressive Training Recommendation -->
            <div id="progressive-recommendation" class="progressive-recommendation">
                <h2>Today's Recommended Training</h2>
                <div class="recommended-weight" id="recommended-weight">1 lb</div>
                <div class="week-info" id="week-info">Week 1 • Starting Phase</div>
                <div class="reps-info" id="reps-info">25 repetitions per set</div>
            </div>

            <div id="progress-motivator"></div>
            <div id="gym-status"></div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('workout', event)">Workout</button>
                <button class="nav-tab" onclick="showTab('stats', event)">Stats</button>
                <button class="nav-tab" onclick="showTab('history', event)">History</button>
                <a href="/dashboard" class="nav-tab">Dashboard</a>
            </div>

            <div id="workout-tab" class="tab-content active">
                <div id="setup-screen" class="workout-setup">
                    <div class="motivational-section">
                        <div class="motivational-quote" id="motivational-quote">
                            "Consistency builds champions"
                        </div>
                        <div id="daily-motivation"></div>
                    </div>

                    <div class="duration-input-section">
                        <h3>Workout Duration</h3>
                        
                        <div class="quick-duration-btns">
                            <button class="quick-btn" onclick="setDuration(10)">10 min</button>
                            <button class="quick-btn" onclick="setDuration(20)">20 min</button>
                            <button class="quick-btn" onclick="setDuration(30)">30 min</button>
                            <button class="quick-btn" onclick="setDuration(45)">45 min</button>
                            <button class="quick-btn" onclick="setDuration(60)">1 hour</button>
                            <button class="quick-btn" onclick="setDuration(90)">1.5 hours</button>
                        </div>

                        <div class="duration-controls">
                            <label for="duration-input" style="color: #ffffff; font-weight: 600;">Custom Duration (minutes):</label>
                            <input type="number" id="duration-input" class="duration-input" value="30" min="5" max="180" onchange="updateExerciseBreakdown()">
                        </div>

                        <div class="exercise-breakdown" id="exercise-breakdown">
                            <strong>Workout Breakdown:</strong><br>
                            <span id="breakdown-text">15 exercises total • 1 warmup + 14 working sets</span>
                        </div>
                    </div>

                    <div class="weight-input">
                        <label for="starting-weight">Override Weight (optional):</label>
                        <input type="number" id="starting-weight" value="" min="1" max="10" step="1" placeholder="Use recommended">
                        <p style="color: #a0a0a0; font-size: 0.9em; margin-top: 5px;">Leave empty to use recommended weight above</p>
                    </div>

                    <button class="start-btn" onclick="startWorkout()">Start Workout</button>
                </div>

                <div id="timer-screen" class="timer-display" style="display: none;">
                    <div id="next-exercise-warning" style="display: none;"></div>
                    <div class="current-exercise" id="current-exercise">Warmup</div>
                    <div class="timer" id="timer-display">2:00</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>

                    <div class="workout-info">
                        <div class="info-card">
                            <div class="info-label">Current Weight</div>
                            <div class="info-value" id="current-weight">1 lbs</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Total Time</div>
                            <div class="info-value" id="total-time">0:00</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Exercise</div>
                            <div class="info-value" id="exercise-count">1 / 15</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">Remaining</div>
                            <div class="info-value" id="remaining-time">30:00</div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="control-btn pause-btn" onclick="togglePause()" id="pause-btn">Pause</button>
                        <button class="control-btn skip-btn" onclick="showSkipModal()">Skip</button>
                        <button class="control-btn stop-btn" onclick="stopWorkout()">Stop</button>
                    </div>
                </div>
            </div>

            <div id="stats-tab" class="tab-content">
                <div id="stats-loading" class="loading">Loading stats...</div>
                <div id="stats-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-title">Total Workouts</div>
                            <div class="stat-value" id="total-workouts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Total Time</div>
                            <div class="stat-value" id="total-time-stats">0h 0m</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">This Week</div>
                            <div class="stat-value" id="this-week-workouts">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Max Weight</div>
                            <div class="stat-value" id="max-weight">0 lbs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Streak</div>
                            <div class="stat-value" id="current-streak">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Week Goal</div>
                            <div class="stat-value" id="weekly-progress">0/7</div>
                        </div>
                    </div>

                    <div class="achievements" id="achievements">
                        <!-- Achievements will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="history-tab" class="tab-content">
                <h2 style="text-align: center; margin-bottom: 20px; color: #ffffff;">Workout History</h2>
                <div id="history-loading" class="loading">Loading history...</div>
                <div id="history-list" style="display: none;">
                    <!-- History will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Progressive training system
        function getProgressionData() {
            return [
                // 1-5 pounds progression (6 weeks each)
                { weightRange: "1-5 lbs", weeks: [
                    { week: 1, weight: 1, reps: 25, description: "Starting light - focus on form" },
                    { week: 2, weight: 1, reps: 30, description: "Building endurance" },
                    { week: 3, weight: 1, reps: 35, description: "Increasing volume" },
                    { week: 4, weight: 1, reps: 40, description: "Higher repetitions" },
                    { week: 5, weight: 1, reps: 45, description: "Peak volume" },
                    { week: 6, weight: 1, reps: 50, description: "Maximum reps before progression" }
                ]},
                { weightRange: "1-5 lbs", weeks: [
                    { week: 7, weight: 2, reps: 25, description: "Weight increase - back to base reps" },
                    { week: 8, weight: 2, reps: 30, description: "Building with new weight" },
                    { week: 9, weight: 2, reps: 35, description: "Adapting to 2 lbs" },
                    { week: 10, weight: 2, reps: 40, description: "Strength building" },
                    { week: 11, weight: 2, reps: 45, description: "High volume training" },
                    { week: 12, weight: 2, reps: 50, description: "Ready for next progression" }
                ]},
                { weightRange: "1-5 lbs", weeks: [
                    { week: 13, weight: 3, reps: 25, description: "3 lb progression" },
                    { week: 14, weight: 3, reps: 30, description: "Building endurance" },
                    { week: 15, weight: 3, reps: 35, description: "Strength gains" },
                    { week: 16, weight: 3, reps: 40, description: "Consistent progress" },
                    { week: 17, weight: 3, reps: 45, description: "Peak training" },
                    { week: 18, weight: 3, reps: 50, description: "Maximum volume" }
                ]},
                { weightRange: "1-5 lbs", weeks: [
                    { week: 19, weight: 4, reps: 25, description: "4 lb challenge" },
                    { week: 20, weight: 4, reps: 30, description: "Adaptation phase" },
                    { week: 21, weight: 4, reps: 35, description: "Building power" },
                    { week: 22, weight: 4, reps: 40, description: "Strength development" },
                    { week: 23, weight: 4, reps: 45, description: "High intensity" },
                    { week: 24, weight: 4, reps: 50, description: "Peak performance" }
                ]},
                { weightRange: "1-5 lbs", weeks: [
                    { week: 25, weight: 5, reps: 25, description: "5 lb milestone" },
                    { week: 26, weight: 5, reps: 30, description: "New strength level" },
                    { week: 27, weight: 5, reps: 35, description: "Advanced training" },
                    { week: 28, weight: 5, reps: 40, description: "Power building" },
                    { week: 29, weight: 5, reps: 45, description: "Elite endurance" },
                    { week: 30, weight: 5, reps: 50, description: "Ready for 6-10 lb phase" }
                ]},
                // 6-10 pounds progression (12 weeks each)
                { weightRange: "6-10 lbs", weeks: [
                    { week: 31, weight: 6, reps: 25, description: "6-10 lb phase begins" },
                    { week: 32, weight: 6, reps: 25, description: "Adapting to heavier weight" },
                    { week: 33, weight: 6, reps: 30, description: "Building with 6 lbs" },
                    { week: 34, weight: 6, reps: 30, description: "Strength consolidation" },
                    { week: 35, weight: 6, reps: 35, description: "Progressive overload" },
                    { week: 36, weight: 6, reps: 35, description: "Mastering 6 lbs" },
                    { week: 37, weight: 6, reps: 40, description: "Higher volume" },
                    { week: 38, weight: 6, reps: 40, description: "Peak 6 lb training" },
                    { week: 39, weight: 6, reps: 45, description: "Maximum endurance" },
                    { week: 40, weight: 6, reps: 45, description: "Elite level" },
                    { week: 41, weight: 6, reps: 50, description: "Peak volume" },
                    { week: 42, weight: 6, reps: 50, description: "Ready for 7 lbs" }
                ]},
                { weightRange: "6-10 lbs", weeks: [
                    { week: 43, weight: 7, reps: 25, description: "7 lb progression" },
                    { week: 44, weight: 7, reps: 25, description: "New weight adaptation" },
                    { week: 45, weight: 7, reps: 30, description: "Building strength" },
                    { week: 46, weight: 7, reps: 30, description: "Consistent progress" },
                    { week: 47, weight: 7, reps: 35, description: "Power development" },
                    { week: 48, weight: 7, reps: 35, description: "Strength gains" },
                    { week: 49, weight: 7, reps: 40, description: "Advanced training" },
                    { week: 50, weight: 7, reps: 40, description: "Peak 7 lb phase" },
                    { week: 51, weight: 7, reps: 45, description: "High intensity" },
                    { week: 52, weight: 7, reps: 45, description: "Year milestone" },
                    { week: 53, weight: 7, reps: 50, description: "Maximum volume" },
                    { week: 54, weight: 7, reps: 50, description: "Ready for 8 lbs" }
                ]},
                { weightRange: "6-10 lbs", weeks: [
                    { week: 55, weight: 8, reps: 25, description: "8 lb challenge" },
                    { week: 56, weight: 8, reps: 25, description: "Adaptation period" },
                    { week: 57, weight: 8, reps: 30, description: "Building endurance" },
                    { week: 58, weight: 8, reps: 30, description: "Strength building" },
                    { week: 59, weight: 8, reps: 35, description: "Progressive training" },
                    { week: 60, weight: 8, reps: 35, description: "Power gains" },
                    { week: 61, weight: 8, reps: 40, description: "Advanced level" },
                    { week: 62, weight: 8, reps: 40, description: "Peak 8 lb training" },
                    { week: 63, weight: 8, reps: 45, description: "Elite endurance" },
                    { week: 64, weight: 8, reps: 45, description: "Maximum effort" },
                    { week: 65, weight: 8, reps: 50, description: "Peak volume" },
                    { week: 66, weight: 8, reps: 50, description: "Ready for 9 lbs" }
                ]},
                { weightRange: "6-10 lbs", weeks: [
                    { week: 67, weight: 9, reps: 25, description: "9 lb progression" },
                    { week: 68, weight: 9, reps: 25, description: "Heavy weight adaptation" },
                    { week: 69, weight: 9, reps: 30, description: "Building with 9 lbs" },
                    { week: 70, weight: 9, reps: 30, description: "Strength consolidation" },
                    { week: 71, weight: 9, reps: 35, description: "Power development" },
                    { week: 72, weight: 9, reps: 35, description: "Advanced training" },
                    { week: 73, weight: 9, reps: 40, description: "High intensity" },
                    { week: 74, weight: 9, reps: 40, description: "Peak 9 lb phase" },
                    { week: 75, weight: 9, reps: 45, description: "Elite performance" },
                    { week: 76, weight: 9, reps: 45, description: "Maximum endurance" },
                    { week: 77, weight: 9, reps: 50, description: "Peak volume" },
                    { week: 78, weight: 9, reps: 50, description: "Ready for 10 lbs" }
                ]},
                { weightRange: "6-10 lbs", weeks: [
                    { week: 79, weight: 10, reps: 25, description: "10 lb milestone!" },
                    { week: 80, weight: 10, reps: 25, description: "Maximum weight adaptation" },
                    { week: 81, weight: 10, reps: 30, description: "Building with 10 lbs" },
                    { week: 82, weight: 10, reps: 30, description: "Elite strength" },
                    { week: 83, weight: 10, reps: 35, description: "Peak power" },
                    { week: 84, weight: 10, reps: 35, description: "Advanced athlete" },
                    { week: 85, weight: 10, reps: 40, description: "Maximum intensity" },
                    { week: 86, weight: 10, reps: 40, description: "Elite level" },
                    { week: 87, weight: 10, reps: 45, description: "Peak performance" },
                    { week: 88, weight: 10, reps: 45, description: "Champion level" },
                    { week: 89, weight: 10, reps: 50, description: "Maximum volume" },
                    { week: 90, weight: 10, reps: 50, description: "Program complete!" }
                ]}
            ];
        }

        // Motivational quotes
        const motivationalQuotes = [
            "Consistency builds champions",
            "Every rep counts",
            "Progress over perfection", 
            "Show up and do the work",
            "Your future self will thank you",
            "Strength comes from within",
            "Push through the resistance",
            "Make it happen",
            "Focus on the process",
            "Results follow effort"
        ];

        // Calculate current week based on workout count
        function calculateCurrentWeek(totalWorkouts) {
            const averageWorkoutsPerWeek = 3.5;
            return Math.floor(totalWorkouts / averageWorkoutsPerWeek) + 1;
        }

        // Get current weight and reps recommendation
        function getCurrentRecommendation(totalWorkouts) {
            const currentWeek = calculateCurrentWeek(totalWorkouts);
            
            // 1-5 lb phase: 6 weeks per weight
            if (currentWeek <= 6) {
                return { weight: 1, reps: 25 + (currentWeek - 1) * 5, week: currentWeek, phase: "1-5 lbs" };
            } else if (currentWeek <= 12) {
                return { weight: 2, reps: 25 + (currentWeek - 7) * 5, week: currentWeek, phase: "1-5 lbs" };
            } else if (currentWeek <= 18) {
                return { weight: 3, reps: 25 + (currentWeek - 13) * 5, week: currentWeek, phase: "1-5 lbs" };
            } else if (currentWeek <= 24) {
                return { weight: 4, reps: 25 + (currentWeek - 19) * 5, week: currentWeek, phase: "1-5 lbs" };
            } else if (currentWeek <= 30) {
                return { weight: 5, reps: 25 + (currentWeek - 25) * 5, week: currentWeek, phase: "1-5 lbs" };
            }
            // 6-10 lb phase: 12 weeks per weight
            else if (currentWeek <= 42) {
                const weekInPhase = ((currentWeek - 31) % 12) + 1;
                let reps;
                if (weekInPhase <= 2) reps = 25;
                else if (weekInPhase <= 4) reps = 30;
                else if (weekInPhase <= 6) reps = 35;
                else if (weekInPhase <= 8) reps = 40;
                else if (weekInPhase <= 10) reps = 45;
                else reps = 50;
                return { weight: 6, reps: reps, week: currentWeek, phase: "6-10 lbs" };
            } else if (currentWeek <= 54) {
                const weekInPhase = ((currentWeek - 43) % 12) + 1;
                let reps;
                if (weekInPhase <= 2) reps = 25;
                else if (weekInPhase <= 4) reps = 30;
                else if (weekInPhase <= 6) reps = 35;
                else if (weekInPhase <= 8) reps = 40;
                else if (weekInPhase <= 10) reps = 45;
                else reps = 50;
                return { weight: 7, reps: reps, week: currentWeek, phase: "6-10 lbs" };
            } else if (currentWeek <= 66) {
                const weekInPhase = ((currentWeek - 55) % 12) + 1;
                let reps;
                if (weekInPhase <= 2) reps = 25;
                else if (weekInPhase <= 4) reps = 30;
                else if (weekInPhase <= 6) reps = 35;
                else if (weekInPhase <= 8) reps = 40;
                else if (weekInPhase <= 10) reps = 45;
                else reps = 50;
                return { weight: 8, reps: reps, week: currentWeek, phase: "6-10 lbs" };
            } else if (currentWeek <= 78) {
                const weekInPhase = ((currentWeek - 67) % 12) + 1;
                let reps;
                if (weekInPhase <= 2) reps = 25;
                else if (weekInPhase <= 4) reps = 30;
                else if (weekInPhase <= 6) reps = 35;
                else if (weekInPhase <= 8) reps = 40;
                else if (weekInPhase <= 10) reps = 45;
                else reps = 50;
                return { weight: 9, reps: reps, week: currentWeek, phase: "6-10 lbs" };
            } else if (currentWeek <= 90) {
                const weekInPhase = ((currentWeek - 79) % 12) + 1;
                let reps;
                if (weekInPhase <= 2) reps = 25;
                else if (weekInPhase <= 4) reps = 30;
                else if (weekInPhase <= 6) reps = 35;
                else if (weekInPhase <= 8) reps = 40;
                else if (weekInPhase <= 10) reps = 45;
                else reps = 50;
                return { weight: 10, reps: reps, week: currentWeek, phase: "6-10 lbs" };
            }
            
            // Beyond program completion
            return { weight: 10, reps: 50, week: currentWeek, phase: "Advanced", description: "Program complete - maintain or create new goals" };
        }

        // Workout data and state
        let workoutData = {
            duration: 30, // minutes
            startingWeight: 1,
            exercises: ['Warmup', 'Flys', 'Side Raises', 'Overhead', 'Flys', 'Side Raises'],
            exerciseTime: 2 * 60, // 2 minutes in seconds
            currentExercise: 0,
            currentWeight: 1,
            timeRemaining: 2 * 60,
            totalElapsed: 0,
            totalWorkoutTime: 0,
            isRunning: false,
            isPaused: false,
            intervalId: null,
            lastBeepTime: 0,
            workoutId: null
        };

        const workoutColors = {
            Warmup: '#10b981', // Green
            Flys: '#dc2626', // Red
            'Side Raises': '#2563eb', // Blue
            Overhead: '#f59e0b', // Yellow
        };

        // Global variable to store current recommended reps
        let currentRecommendedReps = 25;

        // Motivational quotes for skip confirmation
        const skipQuotes = [
            "Champions are made when nobody's watching. Every rep matters.",
            "The pain you feel today is the strength you feel tomorrow.",
            "Don't stop when you're tired. Stop when you're done.",
            "Your only competition is who you were yesterday.",
            "Excuses don't burn calories. Keep pushing.",
            "The hardest part is showing up. You're already here.",
            "Progress happens outside your comfort zone.",
            "Every champion was once a beginner who refused to give up.",
            "You're stronger than your excuses.",
            "The body achieves what the mind believes."
        ];

        // Audio context for beeps
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playBeep(frequency = 800, duration = 200) {
            if (!audioContext) initAudio();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // User management
        function getUserId() {
            const username = localStorage.getItem('workoutUsername');
            if (!username) {
                return null; // Will trigger username modal
            }
            return `user_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
        }

        function getUsername() {
            return localStorage.getItem('workoutUsername');
        }

        async function setUsername() {
            const usernameInput = document.getElementById('username-input');
            const username = usernameInput.value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            if (username.length < 2) {
                alert('Username must be at least 2 characters long');
                return;
            }
            
            // Validate username (alphanumeric and basic chars only)
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                alert('Username can only contain letters, numbers, hyphens, and underscores');
                return;
            }
            
            try {
                // Check if username exists by trying to get stats
                const userId = `user_${username.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
                const existingStats = await apiCall(`/workouts/stats/${userId}`);
                
                // Store username
                localStorage.setItem('workoutUsername', username);
                
                // Hide modal and show user info
                document.getElementById('username-modal').style.display = 'none';
                document.getElementById('current-username').textContent = username;
                document.getElementById('user-info').style.display = 'flex';
                
                // If user has existing data, welcome them back
                if (existingStats && existingStats.success && existingStats.totalWorkouts > 0) {
                    const recommendation = getCurrentRecommendation(existingStats.totalWorkouts);
                    setTimeout(() => {
                        alert(`Welcome back, ${username}! You have ${existingStats.totalWorkouts} workouts completed. Today's recommendation: ${recommendation.weight} lbs, ${recommendation.reps} reps.`);
                    }, 500);
                } else {
                    setTimeout(() => {
                        alert(`Welcome to RepForge, ${username}! Start with 1 pound and 25 reps per set.`);
                    }, 500);
                }
                
                // Initialize the app
                init();
                
            } catch (error) {
                console.error('Error setting username:', error);
                alert('There was an error setting your username. Please try again.');
            }
        }

        function changeUser() {
            if (confirm('Are you sure you want to change users? This will switch to a different account.')) {
                localStorage.removeItem('workoutUsername');
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('username-input').value = '';
                document.getElementById('username-modal').style.display = 'flex';
                setupUsernameInput();
            }
        }

        // Check for Enter key in username input
        function setupUsernameInput() {
            const usernameInput = document.getElementById('username-input');
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    setUsername();
                }
            });
            
            // Focus the input when modal opens
            setTimeout(() => {
                usernameInput.focus();
            }, 100);
        }

        // API helper functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`/api${endpoint}`, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return null;
            }
        }

        // Update progressive recommendation display
        async function updateProgressiveRecommendation() {
            const userId = getUserId();
            
            try {
                const stats = await apiCall(`/workouts/stats/${userId}`);
                
                if (stats && stats.success) {
                    const recommendation = getCurrentRecommendation(stats.totalWorkouts);
                    
                    document.getElementById('recommended-weight').textContent = `${recommendation.weight} lb${recommendation.weight > 1 ? 's' : ''}`;
                    document.getElementById('week-info').textContent = `Week ${recommendation.week} • ${recommendation.phase}`;
                    document.getElementById('reps-info').textContent = `${recommendation.reps} repetitions per set`;
                    
                    // Store recommended reps for use in timer display
                    currentRecommendedReps = recommendation.reps;
                    
                    // Update the weight input placeholder
                    const weightInput = document.getElementById('starting-weight');
                    weightInput.placeholder = `${recommendation.weight} lbs (recommended)`;
                    
                } else {
                    // Default for new users
                    document.getElementById('recommended-weight').textContent = '1 lb';
                    document.getElementById('week-info').textContent = 'Week 1 • Starting Phase';
                    document.getElementById('reps-info').textContent = '25 repetitions per set';
                    currentRecommendedReps = 25;
                }
            } catch (error) {
                console.error('Failed to update progressive recommendation:', error);
            }
        }

        // Check gym hours and status
        async function updateGymStatus() {
            try {
                const response = await fetch('/gym-status');
                const gymStatus = await response.json();
                
                if (gymStatus.success) {
                    const statusElement = document.getElementById('gym-status');
                    statusElement.className = `gym-status gym-${gymStatus.status}`;
                    statusElement.innerHTML = gymStatus.message;
                }
            } catch (error) {
                console.error('Failed to get gym status:', error);
            }
        }

        // Get motivational progress message
        async function updateProgressMotivator() {
            const userId = getUserId();
            
            try {
                const stats = await apiCall(`/workouts/stats/${userId}`);
                
                if (stats && stats.success) {
                    const thisWeekWorkouts = stats.thisWeekWorkouts || 0;
                    const workoutsLeft = 7 - thisWeekWorkouts;
                    
                    // Check if user worked out today
                    const history = await apiCall(`/workouts/history/${userId}?limit=1`);
                    const today = new Date().toDateString();
                    const todayWorkout = history?.workouts?.find(w => 
                        new Date(w.endTime || w.startTime).toDateString() === today
                    );
                    
                    let message = '';
                    let isUrgent = false;
                    
                    if (!todayWorkout) {
                        if (workoutsLeft <= 2) {
                            message = `${workoutsLeft} workouts left this week. Today matters.`;
                            isUrgent = true;
                        } else {
                            message = `Day ${thisWeekWorkouts + 1} of 7. You need ${workoutsLeft} more this week.`;
                        }
                    } else {
                        message = `Today's workout complete. ${thisWeekWorkouts}/7 this week.`;
                    }
                    
                    const element = document.getElementById('progress-motivator');
                    if (isUrgent) {
                        element.className = 'urgent-reminder';
                    } else {
                        element.className = 'progress-reminder';
                    }
                    element.innerHTML = message;
                }
            } catch (error) {
                console.error('Failed to update progress motivator:', error);
            }
        }

        // Set duration from quick buttons
        function setDuration(minutes) {
            document.getElementById('duration-input').value = minutes;
            workoutData.duration = minutes;
            updateExerciseBreakdown();
        }

        // Update exercise breakdown
        function updateExerciseBreakdown() {
            const duration = parseInt(document.getElementById('duration-input').value);
            workoutData.duration = duration;
            workoutData.totalWorkoutTime = duration * 60;
            
            const totalExercises = Math.floor(duration / 2);
            const workingSets = totalExercises - 1; // Minus warmup
            
            const breakdown = document.getElementById('breakdown-text');
            breakdown.innerHTML = `
                ${totalExercises} exercises total • 1 warmup + ${workingSets} working sets
            `;
        }

        // Show random motivational quote
        function showRandomQuote() {
            const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            document.getElementById('motivational-quote').textContent = quote;
        }

        // Update daily motivation
        async function updateDailyMotivation() {
            const userId = getUserId();
            
            try {
                const history = await apiCall(`/workouts/history/${userId}?limit=5`);
                const today = new Date().toDateString();
                const todayWorkout = history?.workouts?.find(w => 
                    new Date(w.endTime || w.startTime).toDateString() === today
                );
                
                const motivationElement = document.getElementById('daily-motivation');
                
                if (!todayWorkout) {
                    motivationElement.innerHTML = `
                        <div style="font-size: 1.1em; font-weight: 600;">
                            Ready to get your daily workout done?
                        </div>
                    `;
                } else {
                    motivationElement.innerHTML = `
                        <div style="font-size: 1.1em; font-weight: 600; color: #10b981;">
                            ✓ Daily goal completed! Well done.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to update daily motivation:', error);
            }
        }

                // Find the showTab function in your code and replace it with this improved version
        function showTab(tabName, event) {
            const scrollPosition = window.scrollY; // Store current scroll position
            
            // Hide all tabs with fade out
            document.querySelectorAll('.tab-content').forEach(tab => {
                if (tab.classList.contains('active')) {
                    tab.style.opacity = '0';
                    tab.style.transform = 'translateY(-10px)';
                    
                    setTimeout(() => {
                        tab.classList.remove('active');
                        tab.style.display = 'none';
                        
                        // Reset styles for next appearance
                        tab.style.opacity = '';
                        tab.style.transform = '';
                    }, 200);
                }
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab with fade in
            setTimeout(() => {
                const selectedTab = document.getElementById(tabName + '-tab');
                selectedTab.style.display = 'block';
                
                // Add active class to clicked nav tab
                if (event && event.target) {
                    event.target.classList.add('active');
                } else {
                    // If no event, find the nav tab with the corresponding tabName
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                            tab.classList.add('active');
                        }
                    });
                }
                
                // Update stats when showing stats tab
                if (tabName === 'stats') {
                    // Reset the stats container first
                    document.getElementById('stats-content').style.display = 'none';
                    document.getElementById('stats-loading').style.display = 'block';
                    updateStats();
                } else if (tabName === 'history') {
                    // Reset the history container first
                    document.getElementById('history-list').style.display = 'none';
                    document.getElementById('history-loading').style.display = 'block';
                    updateHistory();
                }
                
                // Force a reflow to ensure transitions work
                selectedTab.offsetHeight;
                
                // Add the active class after a short delay
                setTimeout(() => {
                    selectedTab.classList.add('active');
                    window.scrollTo(0, scrollPosition); // Restore scroll position
                }, 50);
            }, 200);
        }

        // Start workout
        async function startWorkout() {
            initAudio(); // Initialize audio context
            
            const userId = getUserId();
            const duration = workoutData.duration;
            
            // Get weight - use override or recommended
            let startingWeight;
            const overrideWeight = document.getElementById('starting-weight').value;
            if (overrideWeight) {
                startingWeight = parseInt(overrideWeight);
            } else {
                // Use recommended weight
                const stats = await apiCall(`/workouts/stats/${userId}`);
                const recommendation = getCurrentRecommendation(stats?.totalWorkouts || 0);
                startingWeight = recommendation.weight;
            }
            
            try {
                // Start workout on backend
                const result = await apiCall('/workouts/start', 'POST', {
                    userId,
                    duration,
                    startingWeight
                });
                
                if (result && result.success && result.workoutId) {
                    workoutData.workoutId = result.workoutId;
                }
            } catch (error) {
                console.error('Failed to start workout on backend:', error);
            }
            
            workoutData.startingWeight = startingWeight;
            workoutData.currentWeight = startingWeight;
            workoutData.currentExercise = 0;
            workoutData.timeRemaining = workoutData.exerciseTime;
            workoutData.totalElapsed = 0;
            workoutData.isRunning = true;
            workoutData.isPaused = false;
            workoutData.lastBeepTime = 0;

            // Show timer screen
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('timer-screen').style.display = 'block';

            // Update display
            updateTimerDisplay();
            
            // Start timer
            workoutData.intervalId = setInterval(updateTimer, 1000);
        }

        // Update timer
        function updateTimer() {
            if (workoutData.isPaused) return;

            workoutData.timeRemaining--;
            workoutData.totalElapsed++;

            // Handle beeping for last 5 seconds
            if (workoutData.timeRemaining <= 5 && workoutData.timeRemaining > 0) {
                if (workoutData.timeRemaining !== workoutData.lastBeepTime) {
                    playBeep(1000, 150);
                    workoutData.lastBeepTime = workoutData.timeRemaining;
                }
            }

            updateTimerDisplay();

            // Check if exercise is complete
            if (workoutData.timeRemaining <= 0) {
                nextExercise();
            }

            // Check if workout is complete
            const totalExercises = Math.floor(workoutData.duration / 2);
            if (workoutData.currentExercise >= totalExercises) {
                completeWorkout();
            }
        }

        // Move to next exercise
        function nextExercise(isSkip = false) {
            // Play completion sound (only when naturally completing, not when skipping)
            if (!isSkip) {
                playBeep(1200, 300);
            }
            
            workoutData.currentExercise++;
            workoutData.timeRemaining = workoutData.exerciseTime;
            workoutData.lastBeepTime = 0;

            // Progressive weight system - keep same weight throughout workout
            // Weight stays constant during a single workout session
            
            updateTimerDisplay();
            showNextExerciseAnnouncement();
        }

        // Show next exercise announcement
        function showNextExerciseAnnouncement() {
            const totalExercises = Math.floor(workoutData.duration / 2);
            if (workoutData.currentExercise < totalExercises) {
                const nextExerciseIndex = workoutData.currentExercise % workoutData.exercises.length;
                const nextExerciseName = workoutData.exercises[nextExerciseIndex];
                
                const warningElement = document.getElementById('next-exercise-warning');
                warningElement.className = 'next-exercise-warning';
                warningElement.innerHTML = `Now starting: ${nextExerciseName}`;
                warningElement.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    warningElement.style.display = 'none';
                }, 3000);
            }
        }

        // Update timer display with workout color
        function updateTimerDisplay() {
            const minutes = Math.floor(workoutData.timeRemaining / 60);
            const seconds = workoutData.timeRemaining % 60;
            const timerElement = document.getElementById('timer-display');
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Add warning class for last 10 seconds
            if (workoutData.timeRemaining <= 10 && workoutData.timeRemaining > 0) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }

            // Update exercise name and color with rep count
            const exerciseIndex = workoutData.currentExercise % workoutData.exercises.length;
            const currentExerciseName = workoutData.exercises[exerciseIndex];
            const exerciseColor = workoutColors[currentExerciseName] || '#ffffff'; // Default to white

            const currentExerciseElement = document.getElementById('current-exercise');
            
            // Add rep count to exercise name (except for warmup)
            if (currentExerciseName === 'Warmup') {
                currentExerciseElement.textContent = currentExerciseName;
            } else {
                currentExerciseElement.textContent = `${currentExerciseName} (${currentRecommendedReps})`;
            }
            
            currentExerciseElement.style.color = exerciseColor;

            timerElement.style.color = exerciseColor;

            // Update progress bar
            const progress = (workoutData.exerciseTime - workoutData.timeRemaining) / workoutData.exerciseTime * 100;
            document.getElementById('progress-fill').style.width = progress + '%';

            // Update info cards
            document.getElementById('current-weight').textContent = workoutData.currentWeight + ' lbs';

            const totalMinutes = Math.floor(workoutData.totalElapsed / 60);
            const totalSeconds = workoutData.totalElapsed % 60;
            document.getElementById('total-time').textContent =
                `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;

            const totalExercises = Math.floor(workoutData.duration / 2);
            document.getElementById('exercise-count').textContent =
                `${workoutData.currentExercise + 1} / ${totalExercises}`;

            // Update remaining workout time
            const remainingWorkoutTime = workoutData.totalWorkoutTime - workoutData.totalElapsed;
            const remainingMinutes = Math.floor(remainingWorkoutTime / 60);
            const remainingSeconds = remainingWorkoutTime % 60;
            document.getElementById('remaining-time').textContent =
                `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Skip exercise functions
        function showSkipModal() {
            const skipModal = document.getElementById('skip-modal');
            const skipQuote = document.getElementById('skip-quote');
            
            // Show random motivational quote
            const randomQuote = skipQuotes[Math.floor(Math.random() * skipQuotes.length)];
            skipQuote.textContent = randomQuote;
            
            skipModal.style.display = 'flex';
        }

        function confirmSkip() {
            document.getElementById('skip-modal').style.display = 'none';
            
            // Array of disappointment sounds
            const disappointmentSounds = [
                // Original descending pattern
                () => {
                    playBeep(550, 200);
                    setTimeout(() => playBeep(500, 200), 180);
                    setTimeout(() => playBeep(450, 200), 340);
                    setTimeout(() => playBeep(400, 200), 480);
                    setTimeout(() => playBeep(350, 200), 600);
                    setTimeout(() => playBeep(300, 250), 700);
                    setTimeout(() => playBeep(250, 300), 800);
                    setTimeout(() => playBeep(200, 400), 920);
                },
                // Sad Trombone
                () => {
                    playBeep(440, 300);
                    setTimeout(() => playBeep(415, 300), 250);
                    setTimeout(() => playBeep(392, 300), 500);
                    setTimeout(() => playBeep(370, 500), 750);
                },
                // Buzzer of Shame
                () => {
                    playBeep(150, 100);
                    setTimeout(() => playBeep(150, 100), 120);
                    setTimeout(() => playBeep(150, 100), 240);
                    setTimeout(() => playBeep(120, 400), 360);
                },
                // Broken Dreams
                () => {
                    playBeep(880, 150);
                    setTimeout(() => playBeep(440, 200), 100);
                    setTimeout(() => playBeep(220, 300), 200);
                    setTimeout(() => playBeep(110, 400), 400);
                    setTimeout(() => playBeep(80, 600), 700);
                },
                // Alarm of Disappointment
                () => {
                    playBeep(200, 150);
                    setTimeout(() => playBeep(180, 150), 150);
                    setTimeout(() => playBeep(200, 150), 300);
                    setTimeout(() => playBeep(180, 150), 450);
                    setTimeout(() => playBeep(160, 400), 600);
                }
            ];
            
            // Play random disappointment sound
            const randomSound = disappointmentSounds[Math.floor(Math.random() * disappointmentSounds.length)];
            randomSound();
            
            // Account for skipped time (add the remaining time of the current exercise to total elapsed)
            workoutData.totalElapsed += workoutData.timeRemaining;
            
            // Skip to next exercise
            workoutData.currentExercise++;
            workoutData.timeRemaining = workoutData.exerciseTime;
            workoutData.lastBeepTime = 0;
            
            // Check if workout is complete after skipping
            const totalExercises = Math.floor(workoutData.duration / 2);
            if (workoutData.currentExercise >= totalExercises) {
                completeWorkout();
                return;
            }
            
            // Update display and announce next exercise
            updateTimerDisplay();
            showNextExerciseAnnouncement();
        }

        function cancelSkip() {
            document.getElementById('skip-modal').style.display = 'none';
            
            // Array of encouraging sounds
            const encouragingSounds = [
                // Original ascending pattern
                () => {
                    playBeep(1000, 300);
                    setTimeout(() => playBeep(1200, 300), 200);
                    setTimeout(() => playBeep(1400, 300), 400);
                    setTimeout(() => playBeep(1600, 300), 600);
                },
                // Victory fanfare
                () => {
                    playBeep(523, 200); // C5
                    setTimeout(() => playBeep(659, 200), 150); // E5
                    setTimeout(() => playBeep(784, 200), 300); // G5
                    setTimeout(() => playBeep(1047, 400), 450); // C6
                },
                // Power chord progression
                () => {
                    playBeep(880, 250); // A5
                    setTimeout(() => playBeep(1108, 250), 200); // C#6
                    setTimeout(() => playBeep(1319, 350), 400); // E6
                },
                // Champion bells
                () => {
                    playBeep(1760, 150); // A6
                    setTimeout(() => playBeep(1760, 150), 180);
                    setTimeout(() => playBeep(2093, 200), 360); // C7
                    setTimeout(() => playBeep(1760, 300), 580);
                },
                // Motivational rise
                () => {
                    playBeep(440, 150);
                    setTimeout(() => playBeep(554, 150), 120);
                    setTimeout(() => playBeep(659, 150), 240);
                    setTimeout(() => playBeep(880, 200), 360);
                    setTimeout(() => playBeep(1108, 300), 480);
                }
            ];
            
            // Play random encouraging sound
            const randomSound = encouragingSounds[Math.floor(Math.random() * encouragingSounds.length)];
            randomSound();
        }

        // Toggle pause
        function togglePause() {
            workoutData.isPaused = !workoutData.isPaused;
            document.getElementById('pause-btn').textContent = workoutData.isPaused ? 'Resume' : 'Pause';
        }

        // Stop workout
        function stopWorkout() {
            if (confirm('Are you sure you want to stop the workout?')) {
                clearInterval(workoutData.intervalId);
                workoutData.isRunning = false;
                
                // Return to setup screen
                document.getElementById('timer-screen').style.display = 'none';
                document.getElementById('setup-screen').style.display = 'block';
                
                showRandomQuote();
                updateDailyMotivation();
                updateProgressiveRecommendation();
            }
        }

        // Complete workout
        async function completeWorkout() {
            clearInterval(workoutData.intervalId);
            workoutData.isRunning = false;

            // Play completion sound
            playBeep(1500, 500);

            const userId = getUserId();
            let backendSuccess = false;

            try {
                // Complete the workout on backend
                if (workoutData.workoutId) {
                    const result = await apiCall(`/workouts/complete/${workoutData.workoutId}`, 'POST', {
                        actualTime: Math.floor(workoutData.totalElapsed / 60),
                        maxWeight: workoutData.currentWeight,
                        completed: true
                    });
                    
                    if (result && result.success) {
                        // Check for new achievements
                        const achievementResult = await apiCall(`/workouts/achievements/check/${userId}`, 'POST');
                        
                        if (achievementResult && achievementResult.newAchievements && achievementResult.newAchievements.length > 0) {
                            // Show achievement notifications
                            setTimeout(() => {
                                achievementResult.newAchievements.forEach(achievement => {
                                    alert(`🏆 Achievement Unlocked: ${achievement.name}!`);
                                });
                            }, 1000);
                        }
                        
                        backendSuccess = true;
                    }
                }
            } catch (error) {
                console.error('Failed to save workout to backend:', error);
            }

            // Show completion message with next week's recommendation
            try {
                const stats = await apiCall(`/workouts/stats/${userId}`);
                const newTotal = (stats?.totalWorkouts || 0) + 1;
                const nextRecommendation = getCurrentRecommendation(newTotal);
                
                alert(`🎉 Workout Complete! Great job!\n\nNext workout: ${nextRecommendation.weight} lbs, ${nextRecommendation.reps} reps`);
            } catch (error) {
                alert('🎉 Workout Complete! Great job!');
            }

            // Return to setup screen
            document.getElementById('timer-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
            
            showRandomQuote();
            updateDailyMotivation();
            updateProgressMotivator();
            updateProgressiveRecommendation();
        }

        // Update stats display
        async function updateStats() {
            const userId = getUserId();
            const statsContent = document.getElementById('stats-content');
            const statsLoading = document.getElementById('stats-loading');
            
            try {
                statsLoading.style.display = 'block';
                statsContent.style.display = 'none';
                
                const [stats, achievements] = await Promise.all([
                    apiCall(`/workouts/stats/${userId}`),
                    apiCall(`/workouts/achievements/${userId}`)
                ]);
                
                // Always show stats content, even if data is empty
                if (stats && stats.success) {
                    document.getElementById('total-workouts').textContent = stats.totalWorkouts || 0;
                    
                    const hours = Math.floor((stats.totalTimeMinutes || 0) / 60);
                    const minutes = (stats.totalTimeMinutes || 0) % 60;
                    document.getElementById('total-time-stats').textContent = `${hours}h ${minutes}m`;
                    
                    document.getElementById('this-week-workouts').textContent = stats.thisWeekWorkouts || 0;
                    document.getElementById('max-weight').textContent = (stats.maxWeight || 0) + ' lbs';
                    document.getElementById('current-streak').textContent = stats.currentStreak || 0;
                    document.getElementById('weekly-progress').textContent = stats.weeklyProgress || '0/7';
                }
                
                // Update achievements display
                const achievementsContainer = document.getElementById('achievements');
                const achievementLabels = {
                    'first-workout': 'First Step',
                    'dedication': 'Dedicated (5+ workouts)',
                    'ten-workouts': 'Consistent (10+ workouts)',
                    'consistency': 'Committed (20+ workouts)',
                    'two-pounds': '2 Pound Club',
                    'five-pounds': '5 Pound Club', 
                    'heavy-lifter': 'Heavy Lifter (6 lbs)',
                    'serious-lifter': 'Serious Lifter (8 lbs)',
                    'week-streak': '7-Day Streak',
                    'month-streak': '30-Day Streak',
                    'monthly-master': 'Monthly Master'
                };
        
                achievementsContainer.innerHTML = '';
                if (achievements && achievements.success && achievements.achievements && achievements.achievements.length > 0) {
                    achievements.achievements.forEach(achievementId => {
                        const div = document.createElement('div');
                        div.className = 'achievement';
                        div.textContent = achievementLabels[achievementId] || achievementId;
                        achievementsContainer.appendChild(div);
                    });
                } else {
                    achievementsContainer.innerHTML = '<div style="text-align: center; color: #a0a0a0;">Complete workouts to unlock achievements</div>';
                }
                
                // Always hide loading and show content, even with empty data
                statsLoading.style.display = 'none';
                statsContent.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load stats:', error);
                statsLoading.innerHTML = '<div class="error">Failed to load stats. Please try again.</div>';
            }
        }
        
        // Update history display
        async function updateHistory() {
            const userId = getUserId();
            const historyList = document.getElementById('history-list');
            const historyLoading = document.getElementById('history-loading');
            
            try {
                historyLoading.style.display = 'block';
                historyList.style.display = 'none';
                
                const history = await apiCall(`/workouts/history/${userId}?limit=20`);
                
                // Always show history list, even if empty
                if (history && history.success) {
                    historyList.innerHTML = '';
                    
                    if (history.workouts && history.workouts.length > 0) {
                        history.workouts.forEach(workout => {
                            const div = document.createElement('div');
                            div.className = 'history-item';
                            
                            const date = new Date(workout.endTime || workout.startTime).toLocaleDateString();
                            const time = new Date(workout.endTime || workout.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            div.innerHTML = `
                                <div>
                                    <strong>${date}</strong> at ${time}<br>
                                    <small>${workout.duration}min workout • ${workout.startingWeight}-${workout.maxWeight} lbs</small>
                                </div>
                                <div style="text-align: right;">
                                    <strong>${workout.actualTime || 0}min</strong><br>
                                    <small style="color: #10b981;">✓ Complete</small>
                                </div>
                            `;
                            
                            historyList.appendChild(div);
                        });
                    } else {
                        historyList.innerHTML = '<div style="text-align: center; color: #a0a0a0; padding: 40px;">No workouts yet. Start your first workout to track your progress.</div>';
                    }
                } else {
                    historyList.innerHTML = '<div style="text-align: center; color: #a0a0a0; padding: 40px;">No workouts yet. Start your first workout to track your progress.</div>';
                }
                
                // Always hide loading and show content, even with empty data
                historyLoading.style.display = 'none';
                historyList.style.display = 'block';
                
            } catch (error) {
                console.error('Failed to load history:', error);
                historyLoading.innerHTML = '<div class="error">Failed to load workout history. Please try again.</div>';
            }
        }

        // Initialize app
        async function init() {
            // Check if user has set a username
            const username = getUsername();
            if (!username) {
                document.getElementById('username-modal').style.display = 'flex';
                setupUsernameInput();
                return;
            }
            
            // Show user info
            document.getElementById('current-username').textContent = username;
            document.getElementById('user-info').style.display = 'flex';
            
            showRandomQuote();
            updateExerciseBreakdown();
            
            // Load initial data
            await Promise.all([
                updateProgressiveRecommendation(),
                updateDailyMotivation(),
                updateProgressMotivator(),
                updateGymStatus()
            ]);
            
            // Update gym status every minute
            setInterval(updateGymStatus, 60000);
            
            // Update progress motivator every 5 minutes
            setInterval(updateProgressMotivator, 5 * 60 * 1000);
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>